name: Assignment Pull Request Creator
description: Scans for assignment folders and creates a pull request for each assignment. Supports dry-run mode to simulate operations without making changes.
author: majikmate

inputs:
  github-token:
    description: GitHub token for API access
    required: true
  default-branch:
    description: Default branch to create pull requests against
    required: false
    default: main
  assignment-regex:
    description: List of regular expressions - one per line - to match assignment paths and extract branch names using capturing groups. Use (?P<name>...) for named groups or (...) for unnamed groups. Named groups take priority when both are present.
    required: false
    default: |
      ^assignments/(assignment-\d+)$
  protected-folder-regex:
    description: List of regular expressions - one per line - to match folder paths that should be protected.
    required: false
    default: |
      ^.devcontainer$
      ^.github$
      ^tutorials$
  dry-run:
    description: Simulate operations without actually creating branches or pull requests
    required: false
    default: "false"

outputs:
  created-branches:
    description: List of branches created
    value: ${{ steps.create-assignments.outputs.created-branches }}
  created-pull-requests:
    description: List of pull requests created
    value: ${{ steps.create-assignments.outputs.created-pull-requests }}

runs:
  using: composite
  steps:
    - name: Install assignment-pr-creator
      shell: bash
      run: |
        echo "Installing assignment-pr-creator from GitHub..."

        # Debug: show available environment variables
        echo "DEBUG: GITHUB_ACTION_REF='$GITHUB_ACTION_REF'"
        echo "DEBUG: GITHUB_ACTION_PATH='$GITHUB_ACTION_PATH'"

        # Prefer the explicit ref if present (tags/SHAs show up here)
        if [ -n "$GITHUB_ACTION_REF" ] && [ "$GITHUB_ACTION_REF" != "" ]; then
          REF_FOR_GO="$GITHUB_ACTION_REF"
          echo "Using action reference: $REF_FOR_GO"
        fi

        # If no ref, try the resolved commit from the on-disk action checkout
        if [ -z "$REF_FOR_GO" ] && [ -n "$GITHUB_ACTION_PATH" ]; then
          echo "DEBUG: Attempting to resolve SHA from $GITHUB_ACTION_PATH"
          if ACTUAL_SHA=$(git -C "$GITHUB_ACTION_PATH" rev-parse HEAD 2>/dev/null); then
            REF_FOR_GO="$ACTUAL_SHA"
            echo "Using resolved commit from action checkout: $REF_FOR_GO"
          else
            echo "DEBUG: git rev-parse failed"
          fi
        fi

        # Final fallback (non-reproducible but workable)
        if [ -z "$REF_FOR_GO" ]; then
          REF_FOR_GO="main"
          echo "⚠️  No ref/SHA available; falling back to '$REF_FOR_GO'."
        fi

        if [[ ! "$REF_FOR_GO" =~ ^v[0-9]+(\.[0-9]+)*$ ]]; then
          echo "⚠️  Installing from non-release ref ($REF_FOR_GO). Consider pinning to a release tag for production."
        fi

        go install github.com/majikmate/assignment-pull-request/cmd/assignment-pr-creator@"$REF_FOR_GO"
        echo "✅ assignment-pr-creator installed"    - name: Configure Git
      shell: bash
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Run assignment-pr-creator
      id: create-assignments
      shell: bash
      working-directory: ${{ github.workspace }}
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        DEFAULT_BRANCH: ${{ inputs.default-branch }}
        ASSIGNMENT_REGEX: ${{ inputs.assignment-regex }}
        PROTECTED_FOLDER_REGEX: ${{ inputs.protected-folder-regex }}
        DRY_RUN: ${{ inputs.dry-run }}
      run: |
        assignment-pr-creator

branding:
  icon: git-pull-request
  color: blue
